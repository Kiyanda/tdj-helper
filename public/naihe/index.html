<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>天地劫M 三途川選擇</title>

  <link rel='stylesheet' href='../global.css'>
  <link rel='stylesheet' href='../build/bundle.css'>
  <link rel='icon' type='image/png' href='../tdj-t-128.png'>
  <link rel="apple-touch-icon" href="./tdj-t-128.png">
  <meta name="description" content="天地劫手遊 三途川選擇">
  <meta name="theme-color" content="#eeeeee"/>
</head>
<body>
  <h1>
    <a href="../" title="back">⏴</a>
    <ruby>
      三途川選擇
      <rt style="color: #0003">天地劫M</rt>
    </ruby>
    <a href="./weapon/" title="淬火需求">⏵</a>
  </h1>

  <table id="table">
    <caption id="caption"></caption>
    <colgroup>
      <col width="2em">
      <col width="30%">
      <col width="30%">
      <col width="30%">
    </colgroup>
    <thead id="thead">
      <tr>
        <th>#</th>
        <th>
          靈門<br>
          隊伍強化<br>
          (不疊加)
        </th>
        <th>
          神樹<br>
          英靈強化
        </th>
        <th>
          神龕<br>
          秘寶
        </th>
      </tr>
    </thead>
    <tbody id="tbody">
      <td colspan="4">Loading~</td>
    </tbody>
  </table>

  <hr>

  <details ontoggle="openIframe()">
    <summary>
      原始資料：
      <a id="gsheetlink" target="_blank" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vThfydM3yjBOBsKXVmXDZo6Mr6iHiQO0di-C_J5Ct6bQ1weTorkbV8TOZ7wz0KmAPEk2qMj6zCqHz_J/pubhtml#">天地劫M 三途川 @ Google SpreadSheet</a>
    </summary>
    <iframe id="iframe" frameborder="0"></iframe>
  </details>

  <hr>

  <style>
    body {
      display: block;
      text-align: center;
      max-width: unset;
    }
    table {
      text-align: center;
      border-collapse: collapse;
      margin: auto;
      width: 30em;
      max-width: 100%;
      background-color: #fff3;
    }
    th {
      /* position: sticky; */
      top: 0;
      background-color: #f5f5f5aa;
    }
    td {
      border-bottom: 1px dotted #0003;
      white-space: nowrap;
    }
    td + td {
      height: 3em;
      padding: .5em 0;
      white-space: pre-wrap;
    }
    th,
    tbody tr:nth-of-type(4n) {
      padding-bottom: .5em;
      border-bottom: 6px dotted #0003;
    }
    label {
      display: block;
      padding: 0;
    }
    .checkbox {
      white-space: normal;
    }

    tbody tr:nth-of-type(8n + 1),
    tbody tr:nth-of-type(8n + 2),
    tbody tr:nth-of-type(8n + 3),
    tbody tr:nth-of-type(8n + 4) {
      background-color: #3331;
    }
    tr:hover td {
      background-color: #99f1;
    }

    input:checked + span {
      background-color: #ff06;
    }
    #iframe {
      max-width: 100%;
      width: 36em;
      max-width: 90vw;
      height: 30em;
    }
  </style>

  <script>
    let urlProps = new URLSearchParams(location.search);
    let date = urlProps.get('date') || '0124';
    caption.innerHTML = `<a href="./?date=${date}">${date}↗</a>`;

    openIframe = () => {
      iframe.src = gsheetlink.href;
    };

    fetch(`https://opensheet.elk.sh/1F3nsxZ5ndIhxajYIulzv3vEy2-PzO-6By74QPPWn170/${date}!c2:e22`)
    .then(r => r.json())
    .then(raw => {
      let data = [];
      raw.forEach((d, index) => {
        let N = ~~(index / 4) + 1;
        let n = index % 4 + 1;
        let o = {
          content: [],
          title: `${N}-${n}`,
          boss: n === 4,
        };
        for (let p in d) {
          let type = p.slice(0, 2);
          let value = d[p].replace(/\r\n|\n|\r/g, '\n');
          let checkbox = n !== 4 && type === '靈門';
          o.content.push({
            type,
            checkbox,
            value: checkbox ? value.split('\n') : value,
          });
        }
        data[index] = o;
      });

      let tmpl = data.map(row => {
        let content = '';
        if (row.boss) {
          content = `
            <td colspan="3">${row.content[0]?.value || ''}</td>`;
        } else {
          content = row.content.map(td => {
            let innerContent = '';
            if (td.value?.length > 2) {
              innerContent = td.checkbox
               ? td.value.map(item => `
                  <label><input type="radio" name="${row.title}"> <span>${item}</span></label>
                `.trim()).join('')
               : `
                <label><input type="radio" name="${row.title}"> <span>${td.value}</span></label>
                `.trim();
            } else {
              innerContent = td.value || '';
            }
            return `
              <td class="${td.checkbox ? 'checkbox' : ''}">${innerContent}</td>`.trim();
          }).join('');
        }

        return `
        <tr>
          <td>${row.title}</td>
          ${content}
        </tr>
        `
      });
      tbody.innerHTML = tmpl.join('');
    })
    .catch(err => {
      table.innerHTML = new Error(err);
    })
  </script>
</body>
</html>
